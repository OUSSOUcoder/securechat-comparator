<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation: Processus de Chiffrement E2EE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        let message = '';
        let step = 0;
        let publicKeyA = '';
        let privateKeyA = '';
        let publicKeyB = '';
        let privateKeyB = '';
        let sharedSecret = '';
        let encryptedMessage = '';
        let decryptedMessage = '';

        const steps = [
            { title: '√âtape 1: √âchange de Cl√©s (X3DH)', desc: 'Alice et Bob g√©n√®rent leurs paires de cl√©s publique/priv√©e', color: 'blue' },
            { title: '√âtape 2: Chiffrement du Message', desc: 'Alice chiffre le message avec le secret partag√©', color: 'green' },
            { title: '√âtape 3: Transmission Chiffr√©e', desc: 'Le message circule chiffr√© via le serveur', color: 'purple' },
            { title: '√âtape 4: D√©chiffrement', desc: 'Bob d√©chiffre avec le secret partag√©', color: 'orange' }
        ];

        function randomKey() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function generateKeys() {
            if (!message.trim()) return;
            publicKeyA = `PUB_A_${randomKey()}`;
            privateKeyA = `PRIV_A_${randomKey()}`;
            publicKeyB = `PUB_B_${randomKey()}`;
            privateKeyB = `PRIV_B_${randomKey()}`;
            sharedSecret = `SHARED_${randomKey()}`;
            step = 1;
            render();
        }

        function encryptMsg() {
            if (!message) return;
            const encrypted = btoa(message).split('').map(c => String.fromCharCode(c.charCodeAt(0) + 5)).join('') + `_${sharedSecret.slice(-4)}`;
            encryptedMessage = encrypted;
            step = 2;
            render();
        }

        function decryptMsg() {
            if (!encryptedMessage) return;
            const withoutSecret = encryptedMessage.split('_')[0];
            const decrypted = atob(withoutSecret.split('').map(c => String.fromCharCode(c.charCodeAt(0) - 5)).join(''));
            decryptedMessage = decrypted;
            step = 3;
            render();
        }

        function reset() {
            message = '';
            step = 0;
            publicKeyA = '';
            privateKeyA = '';
            publicKeyB = '';
            privateKeyB = '';
            sharedSecret = '';
            encryptedMessage = '';
            decryptedMessage = '';
            render();
        }

        function render() {
            const app = document.getElementById('app');
            const icons = {
                lock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
                unlock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
                key: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>',
                refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>',
                arrow: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>',
                check: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
                user: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
            };

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
                                <span class="w-10 h-10 text-green-400">${icons.lock}</span>
                                Simulation: Processus de Chiffrement E2EE
                            </h1>
                            <p class="text-lg text-gray-300">Visualisez le protocole Signal (X3DH + Double Ratchet) √©tape par √©tape</p>
                        </div>

                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                ${steps.map((s, idx) => `
                                    <div class="flex-1 flex items-center">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                                            step > idx ? 'bg-green-500 text-white' : step === idx ? 'bg-blue-500 text-white animate-pulse' : 'bg-gray-600 text-gray-400'
                                        }">
                                            ${step > idx ? `<span class="w-6 h-6">${icons.check}</span>` : idx + 1}
                                        </div>
                                        ${idx < steps.length - 1 ? `<div class="flex-1 h-1 mx-2 ${step > idx ? 'bg-green-500' : 'bg-gray-600'}"></div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-center">
                                <h3 class="text-white font-bold text-xl">${steps[step].title}</h3>
                                <p class="text-gray-300 text-sm mt-1">${steps[step].desc}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-8 mb-8">
                            <!-- Alice -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border-2 border-blue-500">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center">
                                        <span class="w-8 h-8 text-white">${icons.user}</span>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-white">Alice</h2>
                                        <p class="text-gray-300 text-sm">√âmetteur</p>
                                    </div>
                                </div>

                                ${step === 0 ? `
                                    <div>
                                        <label class="block text-white font-medium mb-2">Message √† Envoyer</label>
                                        <textarea id="messageInput" placeholder="Ex: Rendez-vous √† 15h au caf√©" rows="4" class="w-full px-4 py-3 rounded-lg bg-white/90 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">${message}</textarea>
                                        <button id="generateButton" onclick="generateKeys()" class="w-full px-6 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2">
                                            <span class="w-5 h-5">${icons.key}</span>
                                            G√©n√©rer les Cl√©s
                                        </button>
                                    </div>
                                ` : ''}

                                ${step >= 1 ? `
                                    <div class="space-y-3">
                                        <div class="bg-blue-500/20 p-3 rounded-lg border border-blue-500/50">
                                            <p class="text-blue-300 text-xs font-semibold mb-1">Cl√© Publique Alice</p>
                                            <p class="text-white font-mono text-sm break-all">${publicKeyA}</p>
                                        </div>
                                        <div class="bg-red-500/20 p-3 rounded-lg border border-red-500/50">
                                            <p class="text-red-300 text-xs font-semibold mb-1">üîí Cl√© Priv√©e Alice (Secr√®te)</p>
                                            <p class="text-white font-mono text-sm break-all">${privateKeyA}</p>
                                        </div>
                                        <div class="bg-green-500/20 p-3 rounded-lg border border-green-500/50">
                                            <p class="text-green-300 text-xs font-semibold mb-1">Secret Partag√© (DH)</p>
                                            <p class="text-white font-mono text-sm break-all">${sharedSecret}</p>
                                        </div>
                                    </div>
                                ` : ''}

                                ${step === 1 ? `
                                    <button onclick="encryptMsg()" class="w-full mt-4 px-6 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2">
                                        <span class="w-5 h-5">${icons.lock}</span>
                                        Chiffrer le Message
                                    </button>
                                ` : ''}

                                ${step >= 2 ? `
                                    <div class="mt-4 bg-purple-500/20 p-4 rounded-lg border border-purple-500/50">
                                        <p class="text-purple-300 text-xs font-semibold mb-2">Message Original</p>
                                        <p class="text-white mb-3">${message}</p>
                                        <span class="w-6 h-6 text-purple-300 mx-auto block">${icons.arrow}</span>
                                        <p class="text-purple-300 text-xs font-semibold mb-2 mt-3">Message Chiffr√© (envoy√©)</p>
                                        <p class="text-white font-mono text-xs break-all">${encryptedMessage}</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Bob -->
                            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border-2 border-orange-500">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center">
                                        <span class="w-8 h-8 text-white">${icons.user}</span>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-white">Bob</h2>
                                        <p class="text-gray-300 text-sm">Destinataire</p>
                                    </div>
                                </div>

                                ${step === 0 ? `
                                    <div class="text-center py-12 text-gray-400">
                                        <span class="w-16 h-16 mx-auto mb-4 opacity-50 block">${icons.lock}</span>
                                        <p>En attente du message d'Alice...</p>
                                    </div>
                                ` : ''}

                                ${step >= 1 ? `
                                    <div class="space-y-3">
                                        <div class="bg-orange-500/20 p-3 rounded-lg border border-orange-500/50">
                                            <p class="text-orange-300 text-xs font-semibold mb-1">Cl√© Publique Bob</p>
                                            <p class="text-white font-mono text-sm break-all">${publicKeyB}</p>
                                        </div>
                                        <div class="bg-red-500/20 p-3 rounded-lg border border-red-500/50">
                                            <p class="text-red-300 text-xs font-semibold mb-1">üîí Cl√© Priv√©e Bob (Secr√®te)</p>
                                            <p class="text-white font-mono text-sm break-all">${privateKeyB}</p>
                                        </div>
                                        <div class="bg-green-500/20 p-3 rounded-lg border border-green-500/50">
                                            <p class="text-green-300 text-xs font-semibold mb-1">Secret Partag√© (DH)</p>
                                            <p class="text-white font-mono text-sm break-all">${sharedSecret}</p>
                                        </div>
                                    </div>
                                ` : ''}

                                ${step === 2 ? `
                                    <div class="mt-4 bg-purple-500/20 p-4 rounded-lg border border-purple-500/50">
                                        <p class="text-purple-300 text-xs font-semibold mb-2">Message Re√ßu (Chiffr√©)</p>
                                        <p class="text-white font-mono text-xs break-all">${encryptedMessage}</p>
                                    </div>
                                    <button onclick="decryptMsg()" class="w-full mt-4 px-6 py-4 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2">
                                        <span class="w-5 h-5">${icons.unlock}</span>
                                        D√©chiffrer le Message
                                    </button>
                                ` : ''}

                                ${step >= 3 ? `
                                    <div class="mt-4 bg-green-500/20 p-4 rounded-lg border-2 border-green-500">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="w-5 h-5 text-green-400">${icons.check}</span>
                                            <p class="text-green-300 font-semibold">Message D√©chiffr√© ‚úì</p>
                                        </div>
                                        <p class="text-white text-lg">${decryptedMessage}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        ${step >= 2 ? `
                            <div class="bg-red-500/20 backdrop-blur-lg rounded-xl p-6 border-2 border-red-500 mb-8">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <span class="w-6 h-6 text-white">${icons.lock}</span>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-red-300 font-bold text-lg mb-2">Point de Vue du Serveur</h3>
                                        <p class="text-white mb-3">Le serveur ne voit que des donn√©es chiffr√©es illisibles :</p>
                                        <div class="bg-black/30 p-3 rounded-lg font-mono text-xs text-red-200 break-all">${encryptedMessage}</div>
                                        <p class="text-gray-300 text-sm mt-3">
                                            ‚úì M√™me compromis, le serveur ne peut pas lire le contenu<br/>
                                            ‚úì Les cl√©s priv√©es restent sur les appareils d'Alice et Bob<br/>
                                            ‚úì Perfect Forward Secrecy: nouvelles cl√©s pour chaque message
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${step >= 3 ? `
                            <button onclick="reset()" class="w-full px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2">
                                <span class="w-5 h-5">${icons.refresh}</span>
                                Recommencer
                            </button>
                        ` : ''}

                        <div class="mt-8 bg-blue-500/20 border border-blue-500/50 rounded-xl p-6">
                            <h3 class="text-blue-300 font-bold text-lg mb-3">üîê Protocole Signal - Composants Techniques</h3>
                            <div class="grid grid-cols-3 gap-6 text-white text-sm">
                                <div>
                                    <p class="font-semibold mb-2 text-yellow-300">X3DH:</p>
                                    <p class="text-gray-300">Extended Triple Diffie-Hellman. √âtablit un secret partag√© de mani√®re asynchrone (m√™me si destinataire offline).</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-2 text-yellow-300">Double Ratchet:</p>
                                    <p class="text-gray-300">Renouvelle les cl√©s constamment. Cl√© unique par message. Forward Secrecy + Future Secrecy garantis.</p>
                                </div>
                                <div>
                                    <p class="font-semibold mb-2 text-yellow-300">Perfect Forward Secrecy:</p>
                                    <p class="text-gray-300">Compromission future des cl√©s n'affecte pas les messages pass√©s. Protection de l'historique.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const input = document.getElementById('messageInput');
            if (input) {
                input.addEventListener('input', (e) => {
                    message = e.target.value;
                    // Mettre √† jour uniquement le bouton
                    const btn = document.getElementById('generateButton');
                    if (btn) {
                        btn.disabled = !message.trim();
                    }
                });
                // √âtat initial du bouton
                const btn = document.getElementById('generateButton');
                if (btn) {
                    btn.disabled = !message.trim();
                }
            }
        }

        window.generateKeys = generateKeys;
        window.encryptMsg = encryptMsg;
        window.decryptMsg = decryptMsg;
        window.reset = reset;

        render();
    </script>
</body>
</html>